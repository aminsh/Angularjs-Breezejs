"use strict";angular.module("dcModal",[]).factory("dialogService",["$q","$http","$templateCache","$timeout",function(a,b,c,d){function e(a,b){for(var c=0,d=i.length;d>c;c++)if(i[c][a]==b)return i[c];return null}function f(){var a=this,b=this.animate?200:0;d(function(){var b=i.indexOf(a);-1!=b&&(a.callStackArray("destroy"),a._ready=!1,i.splice(b,1))},b)}var g=0,h="templates/default.html",i=[],j=[],k=function(b,c){if(b){g++;var d=this;if(this.id=g,this.name=b,this.template=null,this.controller=null,this.className=null,this.animate=!0,this._openDefer=null,this._persistent=!1,this._backdropDisabled=!1,this._ready=!1,this._loadDirective=a.defer(),this._originalTemplate="templates/"+b+".html",c&&angular.isObject(c))if(this.className=c.className,this.animate=!(c.animate===!1),this._persistent=c.persistent,this._backdropDisabled=c.backdrop===!1,angular.isObject(c.controller)){var e=function(a){for(var b in c.controller)c.controller.hasOwnProperty(b)&&(a[b]=c.controller[b]);d.$scope=a};e.$inject=["$scope"],this.controller=e}else angular.isFunction(c.controller)&&(c.controller.$inject=["$scope"],this.controller=c.controller);this._callStack={dismiss:[],destroy:[],ready:[],open:[]},i.push(this),this.loadTemplate().then(function(a){d.template=a,d._loadDirective.promise.then(function(){d._ready=!0,d.callStackArray("ready")})}).catch(function(a){throw new Error(a)})}};return k.prototype.loadTemplate=function(){if(this.deferLoad=a.defer(),this._ready)this.deferLoad.resolve(this.template);else if(this._originalTemplate){var d=this;b.get(this._originalTemplate,{cache:c}).success(function(){d.deferLoad.resolve(d._originalTemplate)}).error(function(){d.deferLoad.resolve(h)})}else this.deferLoad.reject();return this.deferLoad.promise},k.prototype.open=function(b){if(b&&b.preventDefault(),null===this._openDefer){this._openDefer=a.defer();var c=this,e=j.indexOf(this.id),f=function(){j.unshift(c.id),c.show(),c._openDefer.resolve(),c.callStackArray("open"),c._openDefer=null};if(-1===i.indexOf(this))throw this._openDefer.reject(),new Error("Dialog does not exist");this._ready?-1!==e?0!==e&&(j.splice(e,1),j.unshift(this.id)):d(f):this.on("ready",f)}return this._openDefer.promise},k.prototype.dismiss=function(b){b&&b.preventDefault();var c=a.defer(),d=j.indexOf(this.id);return this._ready&&-1!==d?(this.hide(),j.splice(d,1),this.callStackArray("dismiss"),c.resolve()):c.reject(),c.promise},k.prototype.destroy=function(){var a=this;this.dismiss().then(function(){f.call(a)}).catch(function(){f.call(a)})},k.prototype.on=function(a,b){b&&a&&angular.isFunction(b)&&this._callStack.hasOwnProperty(a)&&-1===this._callStack[a].indexOf(b)&&this._callStack[a].push(b)},k.prototype.callStackArray=function(a){for(var b=this._callStack[a]||[],c=0,d=b.length;d>c;c++)b[c].call(this)},k.prototype.close=function(a){this._persistent?this.dismiss(a):this.destroy()},k.prototype.backdropClick=function(a){a&&a.preventDefault(),this._backdropDisabled||this.close(a)},{create:function(a,b){return new k(a,b)},get:function(a){return e("name",a)},getById:function(a){return e("id",a)},allModals:i,openedModals:j}}]).directive("dcModalWidget",["dialogService",function(a){return{restrict:"EA",priority:10,replace:!0,templateUrl:"src/spine.html",link:function(b){b.allModals=a.allModals,b.openedModals=a.openedModals,document.addEventListener("keyup",function(c){if(b.openedModals.length){var d=b.openedModals[0];b.$apply(function(){27==c.keyCode&&d&&a.getById(d).close(c),c.preventDefault(),c.stopPropagation()})}})}}}]).directive("dcModal",["dialogService","$timeout",function(a,b){return{restrict:"EA",priority:200,scope:{modalId:"="},link:function(c,d){var e=a.getById(c.modalId);e.show=function(){b(function(){d.addClass("revealed")},10)},e.hide=function(){b(function(){d.removeClass("revealed")})},e._loadDirective.resolve()}}}]).directive("dcBackdrop",["dialogService",function(a){return{restrict:"EA",priority:100,replace:!0,template:'<div class="dc-modal-backdrop" ng-class="{shown: openedModals.length}"></div>',link:function(b,c){c[0].addEventListener("mouseup",function(c){b.$apply(function(){a.getById(b.openedModals[0]).backdropClick(c)})})}}}]).run(["$compile","$rootScope","$timeout",function(a,b,c){c(function(){angular.element(document.body)[0].appendChild(a(angular.element("<dc-modal-widget />")[0])(b)[0])})}]);